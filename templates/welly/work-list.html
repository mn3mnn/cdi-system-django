{% extends 'welly/elements/layouts/admin.html' %}
{% load static %}

{% block additional_css %}
{% endblock %}

{% block content %}
<!--**********************************
	Content body start
***********************************-->
<div class="content-body">
	<!-- row -->
	<div class="container-fluid">

        <div class="align-items-center d-flex mb-sm-4 mb-3">
			<div class="me-auto">
				<h2 class="text-black font-w600">Work List</h2>
			</div>
			{% if role == "manager" %}
                <div>
                    <a href="javascript:void(0)" class="btn btn-primary me-3" data-bs-toggle="modal"
                        data-bs-target="#addOrderModal">+ Assign</a>
                </div>
            {% endif %}
		</div>
		<!-- Add Order -->
		{% if role == "manager" %}
            <div class="modal fade" id="addOrderModal">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Assign To</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal">
                            </button>
                        </div>
                        <div class="modal-body py-3">
                            <form>
                                {% csrf_token %}
                                <label for="single-select" class="form-label me-3 mb-0">Assign selected to</label>
                                <select id="single-select" class="w-50">
                                    {% for specialist in specialists %}
                                        <option value="{{ specialist.specialist_id }}">{{ specialist.name }}</option>
                                    {% endfor %}
                                </select>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-danger light" data-bs-dismiss="modal">Close</button>
                            <button type="button" onclick="assignItems()" class="btn btn-primary">Assign</button>
                        </div>
                    </div>
                </div>
            </div>
		{% endif %}

        <div class="row">
			<div class="col-xl-12">
				<div class="table-responsive card-table">
					<table id="example5" class="display dataTablesCard white-border table-responsive-xl">
						<thead>
							<tr>
								<th>
									<div class="form-check custom-checkbox">
										<input type="checkbox" class="form-check-input" id="checkAll" required="">
										<label class="form-check-label" for="checkAll"></label>
									</div>
								</th>
								<th>PID</th>
								<th>PName</th>
                                {% if role == "manager" %}
                                    <th>Assigned To</th>
                                {% endif %}
								<th>Encounter</th>
								<th>Assignment</th>
								<th>Open Queries</th>
								<th>S Priority</th>
								<th>M Priority</th>
								<th>Status</th>
								<th>Physician</th>
								<th>Speciality</th>
								<th>Facility</th>
							</tr>
						</thead>
						<tbody>
							{% for work in work_list_items %}
                                <tr data-href="{% url 'welly:details' work.work_list_id %}" data-work_list_id={{ work.work_list_id }}>
                                    <td>
                                        <div class="form-check custom-checkbox">
                                            <input type="checkbox" class="form-check-input" id="check1" required="">
                                            <label class="form-check-label" for="check1"></label>
                                        </div>
                                    </td>
                                    <td>{{ work.patient_id }}</td>
                                    <td>{{ work.patient_name }}</td>
                                    {% if role == "manager" %}
                                        <td>{{ work.assigned_specialist }}</td>
                                    {% endif %}
                                    <td>{{ work.encounter_date }}</td>
                                    <td>{{ work.assignment_date }}</td>
                                    <td>{{ work.open_queries }}</td>
                                    <td>{{ work.sys_priority }}</td>
                                    <td>{{ work.manual_priority }}</td>
                                    <td>{{ work.status }}</td>
                                    <td>{{ work.physician }}</td>
                                    <td>{{ work.speciality }}</td>
                                    <td>{{ work.facility }}</td>
                                </tr>
                            {% endfor %}
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
</div>
<!--**********************************
	Content body end
***********************************-->
{% endblock %}
{% block additional_js %}
<script>
	$(document).ready(function () {
		$("#example5 tbody tr :not(:nth-child(1))").on("click", function () {
            console.log('clicked');
			var href = $(this).parent().data("href");
			if (href) {
				window.location.href = href;
			}
		});

		(function ($) {
			var table = $('#example5').DataTable({
				searching: true,
				paging: true,
				select: true,
				//info: false,         
				lengthChange: true

			});
			{#$('#example5 tbody').on('click', 'tr', function () {#}
			{#	var data = table.row(this).data();#}
			{#	var href = $(this).data("href");#}
			{#	if (href) {#}
			{#		window.location.href = href;#}
			{#	}#}
			{#);#}
			{#$('#example5 tbody').on('click', 'input[type="checkbox"]', function (event) {#}
			{#	event.stopPropagation();#}
			{#);#}
		})(jQuery);
	});

</script>

<script>
    function assignItems() {
        var selectedItems = [];
        var checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
        checkboxes.forEach(function(checkbox) {
            selectedItems.push(checkbox.closest('tr').dataset.work_list_id);
        });

        var selectedSpecialist = document.getElementById('single-select').value;
        // Get CSRF token
        var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Send AJAX POST request
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/assign/');
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.setRequestHeader('X-CSRFToken', csrfToken); // Include CSRF token in request headers
        xhr.onload = function() {
            if (xhr.status === 201) {
                // Handle successful response
                console.log(xhr.responseText);
                window.alert('work assigned successfully');
                document.location.reload();

            } else {
                // Handle error response
                console.error('Request failed. Status: ' + xhr.status);
                window.alert('Request failed. Status: ' + xhr.status);
            }
        };
        xhr.send(JSON.stringify({ 'selectedItemsIds': selectedItems, 'selectedSpecialistId': selectedSpecialist }));
    }
</script>


{% endblock %}